<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#181818"/><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ลองพยายามอธิบาย Active Record และ Active Record Migration | wittawasw</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="ลองพยายามอธิบาย Active Record และ Active Record Migration" />
<meta name="author" content="wittawasw" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ลองพยายามเขียนอะไรซักอย่างขึ้นมาอุดช่องว่าง สำหรับคนที่พอเข้าใจการทำงานของฐานข้อมูลอยู่แล้ว แต่แค่ไม่ได้ทำงานด้วย Ruby on Rails มาก่อน ให้สามารถเห็นภาพการทำงานที่ชัดขึ้น" />
<meta property="og:description" content="ลองพยายามเขียนอะไรซักอย่างขึ้นมาอุดช่องว่าง สำหรับคนที่พอเข้าใจการทำงานของฐานข้อมูลอยู่แล้ว แต่แค่ไม่ได้ทำงานด้วย Ruby on Rails มาก่อน ให้สามารถเห็นภาพการทำงานที่ชัดขึ้น" />
<link rel="canonical" href="https://wittawasw.com/2024/06/02/activerecord-and-activerecord-migration.html" />
<meta property="og:url" content="https://wittawasw.com/2024/06/02/activerecord-and-activerecord-migration.html" />
<meta property="og:site_name" content="wittawasw" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-02T14:28:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ลองพยายามอธิบาย Active Record และ Active Record Migration" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"wittawasw"},"dateModified":"2024-06-02T14:28:00+07:00","datePublished":"2024-06-02T14:28:00+07:00","description":"ลองพยายามเขียนอะไรซักอย่างขึ้นมาอุดช่องว่าง สำหรับคนที่พอเข้าใจการทำงานของฐานข้อมูลอยู่แล้ว แต่แค่ไม่ได้ทำงานด้วย Ruby on Rails มาก่อน ให้สามารถเห็นภาพการทำงานที่ชัดขึ้น","headline":"ลองพยายามอธิบาย Active Record และ Active Record Migration","mainEntityOfPage":{"@type":"WebPage","@id":"https://wittawasw.com/2024/06/02/activerecord-and-activerecord-migration.html"},"url":"https://wittawasw.com/2024/06/02/activerecord-and-activerecord-migration.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://wittawasw.com/feed.xml" title="wittawasw" />


  <script type="module">
    import * as Turbo from 'https://cdn.skypack.dev/@hotwired/turbo@7.3.0';
  </script>

  <script src="/javascripts/sw.js"></script>
  <style>
    .turbo-progress-bar {
      background: #79b8ff;
    }

    p {
      text-justify: inter-word;
    }
  </style>
  <link rel="manifest" href="manifest.json" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">wittawasw</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">ลองพยายามอธิบาย Active Record และ Active Record Migration</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-06-02T14:28:00+07:00" itemprop="datePublished">
        Jun 2, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>บทความนี้ได้แรงผลักดันมาจากการที่โดนถามมาเรื่องการทำ Database Migration ของ Rails
ซึ่งส่วนตัวคิดว่าบทความในอินเตอร์เนตเท่าที่หาดู ไม่มีอันไหนช่วยให้เข้าใจได้ดีกว่า
<a href="https://guides.rubyonrails.org/active_record_migrations.html">Official Doc</a> ของ Rails เลย
แต่เราก็เชื่อว่าคนถามน่าจะลองอ่านแล้วล่ะ แต่แค่อาจจะยังไม่ตกผลึกออกมาเป็นแนวปฏิบัติไม่ได้
ก็เลยคิดว่าจะลองพยายามเขียนอะไรซักอย่างขึ้นมาอุดช่องว่าง
สำหรับคนที่พอเข้าใจการทำงานของฐานข้อมูลอยู่แล้ว แต่แค่ไม่ได้ทำงานด้วย Ruby on Rails มาก่อน
ให้สามารถเห็นภาพการทำงานที่ชัดขึ้น</p>

<h2 id="active-record">Active Record</h2>

<p>Model ใน MVC ของ Ruby on Rails นั้นใช้ library ORM เฉพาะของตัวเองที่ชื่อว่า <code class="language-plaintext highlighter-rouge">Active Record</code>
โดยชื่อของ library ก็ได้รับอิทธิพลโดยตรงมาจากแนวคิด
<a href="https://en.wikipedia.org/wiki/Active_record_pattern"><code class="language-plaintext highlighter-rouge">Active record pattern</code></a>
ซึ่งแนวคิดหลักของ pattern นี้ คือ</p>

<ul>
  <li>
    <p>การเข้าถึง table แต่ล่ะ table จะถูก encapsulate อยู่ภายใน class โดยที่แต่ล่ะ instance ของ class ก็คือตัวแทนของ row หรือ record ของข้อมูลใน table และมีวิธีเข้าถึงข้อมูลแต่ล่ะ column ตามชื่อของ column นั้นโดยตรง</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span>
<span class="c1"># =&gt; "User"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">firstname</span>
<span class="c1"># =&gt; "John"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>เมื่อ instance ของ class ได้รับการ initiate ขึ้นมาใหม่และถูก save …จะเท่ากับการ insert
record ใหม่</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">firstname: </span><span class="s2">"John"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># =&gt; INSERT INTO "users" (firstname) VALUES ("John", "2024-06-02 12:34:56", "2024-06-02 12:34:56") RETURNING "id"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>เมื่อ instance ของ class ได้รับการ load จากข้อมูลที่อยู่เดิมและถูก save …จะเท่ากับการ
update record ใหม่</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">firstname: </span><span class="s2">"John"</span><span class="p">).</span><span class="nf">first</span>
<span class="n">user</span><span class="p">.</span><span class="nf">firstname</span> <span class="o">=</span> <span class="s2">"Jack"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># =&gt; UPDATE "users" SET "firstname" = ?, "updated_at" = ? WHERE "users"."id" = ?  [["firstname", "Jack"], ["updated_at", "2024-06-02 11:34:54.562867"], ["id", 1]]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ชื่อของ table กับชื่อของ class จะตั้งตามหลัก
<a href="https://en.wikipedia.org/wiki/Convention_over_configuration">Convention over configuration</a>
ซึ่งสรุปสั้นๆเร็วๆตรงนี้ได้ตามตัวอย่างนี้</p>

    <ul>
      <li>ชื่อ class = ชื่อ entity ของสิ่งที่เราต้องการใช้ในรูปเอกพจน์</li>
      <li>ชื่อ table = ชื่อ entity ของสิ่งที่เราต้องการใช้ในรูปพหูพจน์</li>
    </ul>

    <p><br /></p>

    <blockquote>
      <p>Ex: entity ของ user จะใช้ชื่อ class ว่า User ภายในไฟล์ชื่อ user.rb และอยู่ใน table ที่ชื่อ users</p>
    </blockquote>
  </li>
</ul>

<h2 id="active-record-migration">Active Record Migration</h2>

<p>เป็นเครื่องมือที่ทำมาเพื่อ support การทำงานของ Active Record
เพื่อให้นักพัฒนาสามารถทำงานไปพร้อมๆกันได้ โดยที่สามารถตรวจสอบการเปลี่ยนแปลงของ
Database Schema ได้ตลอด</p>

<blockquote>
  <p>คำว่า Database Schema ในที่นี้หมายถึง spec ของฐานข้อมูลนั้นๆ เช่น ชื่อ table รวมถึงชื่อ  column ภายใน, Primary Key, Foreign Key, Index ต่างๆ รวมถึง trigger หรือ store procedure ด้วย</p>
</blockquote>

<h3 id="อธิบายตามโครงสร้างไฟล์">อธิบายตามโครงสร้างไฟล์</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- config/
  - database.yml
    <span class="c"># ใช้ประกาศค่าต่างๆที่ใช้ในการเชื่อมต่อกับฐานข้อมูล เช่น host, port หรือ</span>
    <span class="c"># connection string</span>
- db/
  - migrate
    <span class="c"># directory ที่ใช้เก็บไฟล์ migration</span>
    <span class="c"># ใช้งานผ่านคำสั่ง rails db:migrate, rails db:rollback</span>
    - ....
  - schema.rb
    <span class="c"># ไฟล์ที่เก็บ schema ปัจจุบันของแอปพลิเคชัน</span>
    <span class="c"># ใช้งานผ่านคำสั่ง rails db:schema:load, rails db:schema:dump</span>
  - seeds.rb
    <span class="c"># ไฟล์ที่ใช้เก็บคำสั่งสำหรับสร้างข้อมูลเบื้องต้นที่จำเป็นในแอปพลิเคชัน</span>
    <span class="c"># ใช้งานผ่านคำสั่ง rails db:seed</span>
</code></pre></div></div>

<h2 id="การใช้งานในการทำงานจริงๆเป็นยังไง-">การใช้งานในการทำงานจริงๆเป็นยังไง ?</h2>

<p>จากที่เกริ่นมาทั้งหมดข้างบน คิดว่าหลายคนสามารถอ่านจนเข้าใจได้ไม่มีปัญหา แต่ถ้าจะมีปัญหาก็คือ
แนวทางปฏิบัติตอนที่ทำงานจริง ว่าเป็นยังไงกันแน่ ทำไมลองทำเองดูแล้วมันก็ยังงงๆ
ไม่แน่ใจว่าจะใช่แบบที่ทำรึเปล่า ซึ่งจากประสบการณ์แล้ว ก็ไม่แปลกที่จะงงกันตรงนี้
เพราะคนที่ชอบใช้ Rails แต่ไม่เข้าใจการทำ migration มีอยู่จำนวนไม่น้อยเลย</p>

<blockquote>
  <p>มีทั้งแบบที่แค่หยุดทำไฟล์ migration กับอีกแบบคือหนีไปใช้ NoSQL แบบ MongoDB แทน</p>
</blockquote>

<h3 id="แบบฝึกให้ทำหรือคิดตาม-แอปพลิเคชันซื้อขายสินค้า">แบบฝึกให้ทำหรือคิดตาม: แอปพลิเคชันซื้อขายสินค้า</h3>

<p>สมมติว่า เรากำลังทำแอปพลิเคชันที่สามารถวางขายสินค้าและเปิดให้ผู้ซื้อสามารถสั่งซื้อ
ครั้งละหลายรายการได้ โดยมี entity ที่เราจะใช้ตามนี้</p>

<ul>
  <li>Buyer ผู้ซื้อสินค้า</li>
  <li>Product สินค้า</li>
  <li>Order รายการสั่งซื้อสินค้า</li>
</ul>

<blockquote>
  <p>ต่อจากนี้ไป ทุกครั้งหลังการสร้าง model, migration ให้รันคำสั่ง
<code class="language-plaintext highlighter-rouge">rails db:migrate</code></p>
</blockquote>

<h3 id="ออกแบบ-class-ที่จะใช้-ตามลำดับโปรแกรมที่เขียน">ออกแบบ class ที่จะใช้ ตามลำดับโปรแกรมที่เขียน</h3>

<blockquote>
  <p>สมมติว่าเราเริ่มจากการมีสินค้าในระบบก่อน</p>
</blockquote>

<p>สร้าง model ของ <code class="language-plaintext highlighter-rouge">Product</code> โดยการ generate model
จะเป็นการสร้างไฟล์ model และ migration ขึ้นมา</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate model product name:string description:text price:integer
</code></pre></div></div>

<p>ก่อนจะไปต่อกันสามารถลองสร้างไฟล์ migration เพื่อเพิ่ม column ง่ายๆได้ เช่น การให้ <code class="language-plaintext highlighter-rouge">Product</code>
สามารถเก็บจำนวน stock ได้</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate migration add_stock_to_products stock:integer
</code></pre></div></div>

<blockquote>
  <p>จะเห็นได้ว่าเราไม่ได้ระบุชื่อ table เป็น parameter
โดยตรงแต่คำสั่งนี้ก็ยังทำงานตามที่เราต้องการได้ เพราะรูปแบบคำสั่งก็ generate
จากชื่อไฟล์ตามแนวคิด Convention over configuration
(จะ generate ไฟล์เปล่าแล้วเขียนเองก็ได้)</p>
</blockquote>

<p>มีสินค้าแล้วเราก็อยากให้การสั่งซื้อสินค้าแต่ล่ะครั้งของ <code class="language-plaintext highlighter-rouge">Buyer</code> ถูกเก็บไว้ใน <code class="language-plaintext highlighter-rouge">Order</code></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate model buyer email:string
rails generate model order buyer:references
</code></pre></div></div>

<p>references คือการสร้าง foreign key พร้อมกับ index ไปที่ resource นั้น
ซึ่ง <code class="language-plaintext highlighter-rouge">buyer:references</code> ในที่นี้ จะทำให้ table <code class="language-plaintext highlighter-rouge">orders</code>
มี column <code class="language-plaintext highlighter-rouge">buyer_id</code> เพิ่มเข้าไปพร้อมกับสร้าง index ให้ โดยไฟล์ <code class="language-plaintext highlighter-rouge">order.rb</code>
ที่ถูกสร้างขึ้นทีหลังจะมีความสัมพันธ์ระบุ <code class="language-plaintext highlighter-rouge">belongs_to :buyer</code> ระบุให้เลย
แต่ในไฟล์ <code class="language-plaintext highlighter-rouge">buyer.rb</code> เราต้องเข้าไปใส่ ความสัมพันธ์เองตามข้างล่าง</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Buyer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>
<span class="k">end</span>
</code></pre></div></div>

<p>พอมาถึงตรงนี้ เราอยากจะให้ความสัมพันธ์ของ <code class="language-plaintext highlighter-rouge">Order</code> กับ <code class="language-plaintext highlighter-rouge">Product</code> เป็นแบบ many-to-many
ซึ่งจากประสบการณ์ของผมค้นพบว่าส่วนมากจะหมดใจกันแถวๆนี้แหละ ที่ไม่รู้จะไปไงต่อดี 😅
จะไปต่อกับไฟล์ migration ก็งงๆ จะข้ามส่วนนี้ไปเลยก็เท่ากับว่าไฟล์ก็มีขั้นตอนไม่ครบแล้ว
ฝืนทำต่อไปก็ไม่สมบูรณ์อยู่ดี</p>

<p>แต่เราลองทำต่อตรงนี้ซักหน่อย เพราะ Active Record Migration
มีวิธีใช้งานที่ผมเองเชื่อว่าครอบคลุม 99% ของการใช้งานทั้งหมดแล้ว
กรณีแบบนี้ก็เช่นกัน</p>

<h3 id="สร้างไฟล์-migration-สำหรับ-join-table">สร้างไฟล์ migration สำหรับ Join Table</h3>

<p>เราสามารถสร้างความสัมพันธ์แบบ many-to-many ได้ ด้วยการสร้าง <code class="language-plaintext highlighter-rouge">join table</code>
ซึ่งใช้คำสั่งสร้างแบบนี้</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate migration CreateJoinTableOrdersProducts order product
</code></pre></div></div>

<p>หลังการรัน <code class="language-plaintext highlighter-rouge">rails db:migrate</code> ในครั้งนี้ เนื่องจากเราไม่ได้ generate model ขึ้นใหม่ เราจึงจำเป็นต้อง  ประกาศความสัมพันธ์เองภายในไฟล์ model ของ <code class="language-plaintext highlighter-rouge">Product</code>, <code class="language-plaintext highlighter-rouge">Order</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:orders</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:buyer</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:products</span>
<span class="k">end</span>
</code></pre></div></div>

<p>มาถึงตรงนี้เราก็น่าจะสามารถลองเล่นกับความสัมพันธ์ใน <code class="language-plaintext highlighter-rouge">rails console</code> ดูได้แบบนี้</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span> <span class="o">=</span> <span class="no">Buyer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'buyer@test.com'</span><span class="p">)</span>
<span class="n">b</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># Insert Buyer b</span>

<span class="nb">p</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'The Shirt'</span><span class="p">)</span>
<span class="nb">p</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># Insert Product p</span>

<span class="n">o</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span>
<span class="n">o</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="nb">p</span>
<span class="n">o</span><span class="p">.</span><span class="nf">buyer</span> <span class="o">=</span> <span class="n">b</span>
<span class="n">o</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># Insert Order o with Buyer b, Product p</span>
</code></pre></div></div>

<h3 id="สิ่งที่อยากให้สนใจหลังแบบฝึกข้างบน">สิ่งที่อยากให้สนใจหลังแบบฝึกข้างบน</h3>

<p>อยากให้ลองศึกษาไฟล์ migration ที่ถูกสร้างขึ้นมาเรียงตามลำดับแล้ว
อาจจะลองรันคำสั่ง <code class="language-plaintext highlighter-rouge">rails db:rollback</code> เปลี่ยนแปลงค่าบางอย่าง แล้วลอง <code class="language-plaintext highlighter-rouge">rails db:migrate</code>
อีกครั้งเพื่อดูผลลัพธ์ที่เกิดขึ้น โดยดูตัวอย่างทั้งหมดจาก
<a href="https://guides.rubyonrails.org/active_record_migrations.html">Official Doc</a></p>

<p>และศึกษาการเปลี่ยนแปลงของไฟล์ <code class="language-plaintext highlighter-rouge">db/schema.rb</code> ไปพร้อมๆกัน</p>

<h3 id="schemarb-คือ-single-source-of-truth-ของ-database-schema"><code class="language-plaintext highlighter-rouge">schema.rb</code> คือ Single Source of Truth ของ Database Schema</h3>

<p>หนึ่งในจุดที่ผมจะเข้าไปเปิดดูเป็นไฟล์แรกๆ หากได้รับมอบหมายให้ทำงานใน Ruby on Rails
แอปพลิเคชัน ก็คือไฟล์ <code class="language-plaintext highlighter-rouge">schema.rb</code> เพราะเป็นไฟล์ที่เราสามารถมองเห็น
ภาพรวมความซับซ้อนของระบบฐานข้อมูลภายในได้ภายในไฟล์เดียว</p>

<h3 id="ถ้าจำนวนไฟล์-migrations-เยอะขึ้นจนจัดการไม่ไหว">ถ้าจำนวนไฟล์ migrations เยอะขึ้นจนจัดการไม่ไหว</h3>

<p>หนึ่งในข้อกังวลอย่างหนึ่งของการเริ่มทำไฟล์ migration ที่ค่อนข้างมีเหตุผล แต่ Active Record
Migration ก็วางแนวทางไว้รับมือแล้ว โดยที่เราสามารถ…</p>

<p>ย้ายไฟล์ที่เก่ามากไปวางที่อื่นหรือลบทิ้งได้เลย แล้วใช้วิธีสร้างฐานข้อมูลเริ่มต้นด้วยคำสั่ง
<code class="language-plaintext highlighter-rouge">rails db:schema:load</code> ให้สร้างฐานข้อมูลตามข้อมูลใน <code class="language-plaintext highlighter-rouge">schema.rb</code> แทนการใช้คำสั่ง
<code class="language-plaintext highlighter-rouge">rails db:migrate</code> เพื่อรันคำสั่งทั้งหมดทีล่ะคำสั่ง</p>

<p>นอกจากการ load schema แล้วก็ยังมี <code class="language-plaintext highlighter-rouge">rails db:schema:dump</code> ที่เป็นคำสั่งตรงข้ามของการ load
โดยเป็นคำสั่งที่เอาข้อมูล schema ในฐานข้อมูลที่เชื่อมต่อลงเก็บที่ <code class="language-plaintext highlighter-rouge">schema.rb</code>
ซึ่งก็สะดวกสำหรับใช้ในการตรวจสอบว่า Database schema ตรงกับที่มีใน <code class="language-plaintext highlighter-rouge">schema.rb</code> หรือไม่
โดยถ้าไฟล์มีการเปลี่ยนแปลงหลังการรันคำสั่งก็สามารถบอกได้ว่าแตกต่างตรงไหนด้วย
Git Version Control</p>

<h3 id="การตรวจสอบสถานะของ-database-migration">การตรวจสอบสถานะของ database migration</h3>

<p>ใช้คำสั่ง <code class="language-plaintext highlighter-rouge">rails  db:migrate:status</code> เพื่อเรียกดูข้อมูลใน terminal
โดยจะเห็นแบบตัวอย่างข้างล่าง</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Status   Migration ID    Migration Name
<span class="nt">--------------------------------------------------</span>
   up     20240508063759  <span class="k">**********</span> NO FILE <span class="k">**********</span>
   up     20240602151931  Create products
   up     20240602154948  Create buyers
   up     20240602155002  Create orders
   up     20240602161438  Create <span class="nb">join </span>table orders products
  down    20240602161959  Add stock to products
</code></pre></div></div>

<h3 id="ข้อดีและข้อเสียของการทำ-migration-แบบนี้">ข้อดีและข้อเสียของการทำ Migration แบบนี้</h3>

<table>
  <thead>
    <tr>
      <th>ข้อดี</th>
      <th>ข้อเสีย</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>สามารถติดตามการเปลี่ยนแปลงได้ Git Version Control เพราะการเปลี่ยนแปลงทั้งหมดถูกทำผ่าน code</td>
      <td>การจัดการด้วย Ruby code ทั้งหมด อาจไม่เหมาะกับองค์กรที่ใช้ DBA แยก เพราะ DBA อาจจะเคืองถ้าโดนบังคับให้เรียน Ruby เพิ่ม 😂</td>
    </tr>
    <tr>
      <td>เพิ่ม abstraction layer ขึ้นมาเพื่อรองรับการเขียน code ครั้งเดียวให้ใช้ได้หลายฐานข้อมูล เช่น สามารถเปลี่ยนไปใช้ MySQL จาก PostgreSQL ได้ทันที</td>
      <td>การ execute คำสั่งโดยตรงอาจมีผลเสียกับ performance ในระบบฐานข้อมูลขนาดใหญ่ ต้องวางแผนให้ดี</td>
    </tr>
    <tr>
      <td>รองรับการ migrate ละ rollback ผ่านคำสั่งที่ program ได้</td>
      <td>ความเสี่ยงจากการทำ data loss ระหว่าง migration เหมือนข้างบน</td>
    </tr>
    <tr>
      <td>การเปลี่ยน schema แต่ล่ะครั้ง สามารถ test ได้</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="alternatively-ถ้าไม่ใช้-ruby-on-rails-แต่อยากได้แบบนี้จะใช้อะไรได้บ้าง">Alternatively ถ้าไม่ใช้ Ruby on Rails แต่อยากได้แบบนี้จะใช้อะไรได้บ้าง</h3>

<ul>
  <li>Liquibase</li>
  <li>Atlas</li>
  <li>golang-migrate</li>
  <li>Gorm</li>
  <li>Prisma</li>
  <li>etc.</li>
</ul>

  </div><a class="u-url" href="/2024/06/02/activerecord-and-activerecord-migration.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      <!--
        <ul class="contact-list">
          <li class="p-name">wittawasw</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul> -->
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links">
      <!--<ul class="social-media-list"></ul>
-->
    </div>

  </div>

</footer>
</body>

</html>
